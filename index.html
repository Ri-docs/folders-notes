<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CFISD DFS/SMB troubleshooting notes – Oct 3, 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold">CFISD – DFS / SMB troubleshooting notes</h1>
      <p class="text-sm text-slate-600 mt-1">Session date: Sep 26, 2025</p>
      <p class="text-sm text-slate-600">Tonight plan: Oct 3, 2025 • Live collaborative checklist (Firestore)</p>
      <p class="text-xs text-slate-500 mt-1">Tip: add <code>?list=cyfair</code> or another id to the URL to create/use a different checklist.</p>
    </header>

    <!-- CHECKLIST -->
    <section class="space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h2 class="text-xl font-semibold">Tonight plan checklist</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btn-mark-all" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800">Mark all done</button>
            <button id="btn-unmark-all" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-900 text-sm hover:bg-slate-200">Unmark all</button>
            <button id="btn-reset" class="px-3 py-1.5 rounded-lg bg-rose-50 text-rose-700 text-sm hover:bg-rose-100">Restore defaults</button>
            <button id="btn-export" class="px-3 py-1.5 rounded-lg bg-sky-50 text-sky-700 text-sm hover:bg-sky-100">Export</button>
          </div>
        </div>

        <!-- Controls -->
        <div class="grid sm:grid-cols-4 gap-3 mt-3">
          <label class="text-sm">Student test ID
            <input id="inp-stu" type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-1.5" placeholder="S249612" />
          </label>
          <label class="text-sm">Employee test ID
            <input id="inp-emp" type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-1.5" placeholder="E085678" />
          </label>
          <label class="flex items-center gap-2 text-sm mt-6 sm:mt-0">
            <input id="chk-enc" type="checkbox" class="size-4" />
            <span>Add <code>-e</code> encryption flag to smbclient</span>
          </label>
          <label class="text-sm">List id (query param)
            <input id="inp-list" type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-1.5" disabled />
          </label>
        </div>

        <!-- Checklist items -->
        <ul id="checklist" class="mt-4 space-y-2"></ul>

        <!-- Add custom item -->
        <div class="mt-4 flex gap-2">
          <input id="inp-new" type="text" class="flex-1 rounded-lg border border-slate-300 px-3 py-1.5" placeholder="Add custom checklist item" />
          <button id="btn-add" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700">Add</button>
        </div>
      </div>

      <!-- QUICK COMMANDS -->
      <div class="bg-white shadow rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Quick commands</h2>
          <div class="text-xs text-slate-500">Run on the appliance. Enter password at the prompt.</div>
        </div>
        <div class="mt-3 grid md:grid-cols-2 gap-4">
          <div class="border rounded-xl p-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">DFS control (student) – list one</h3>
              <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-pre-stu')">Copy</button>
            </div>
            <pre id="cmd-pre-stu" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          </div>
          <div class="border rounded-xl p-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">DFS under test (employee) – list one</h3>
              <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-pre-emp')">Copy</button>
            </div>
            <pre id="cmd-pre-emp" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          </div>
          <div class="border rounded-xl p-3 md:col-span-2">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">Write check on EMP_HOME root</h3>
              <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-write-emp')">Copy</button>
            </div>
            <pre id="cmd-write-emp" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- Recap + Logs -->
    <section class="mt-10 space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">recap</h2>
        <ul class="list-disc pl-6 space-y-1">
          <li>set <code>jcifs.smb.client.dfs.convertToFQDN=true</code> and restarted Folders.</li>
          <li>tested a single user; then turned off User Policies for safety.</li>
          <li><code>smbclient</code> to DFS root worked; <code>STU_HOME</code> traversed; <code>EMP_HOME</code> failed.</li>
          <li>adding <code>CFISD\idauto</code> to <code>emp_home</code> failed from DFS side; points to share/NTFS/SMB policy on the NAS.</li>
        </ul>
      </div>
    </section>

    <footer class="mt-12 pb-12 text-sm text-slate-500">
      <p>prepared for cfisd by identity automation support – updated Oct 3, 2025</p>
    </footer>
  </div>

  <!-- Firebase (compat builds = easiest in a static HTML file) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase config (from your console screenshots) ---
    // If storageBucket differs in your project, update it accordingly.
    const firebaseConfig = {
      apiKey: "AlzaSyBK_f7xHtJS_Yqj6SWF6UGcPLGxX1SVrDw",
      authDomain: "test-d4e6b.firebaseapp.com",
      projectId: "test-d4e6b",
      storageBucket: "test-d4e6b.appspot.com",
      messagingSenderId: "172115547160",
      appId: "1:172115547160:web:9d8190327c4277df0b5f6d"
    };

    // --- App init ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // Optional offline cache
    db.enablePersistence({ synchronizeTabs: true }).catch(() => { /* ignore */ });

    // List id via query param ?list=...
    const listId = new URLSearchParams(location.search).get("list") || "cyfair";
    document.getElementById("inp-list").value = listId;

    // Firestore refs
    const listDoc = db.collection("checklists").doc(listId);
    const itemsCol = listDoc.collection("items");

    // Default plan for tonight (your flow)
    const DEFAULT_ITEMS = [
      { text: "Verify User Policies are OFF", checked: false },
      { text: "Precheck: smbclient DFS control → cd STU_HOME; list one student", checked: false },
      { text: "Precheck: smbclient DFS under test → cd EMP_HOME; list one employee (expect fail)", checked: false },
      { text: "Capture exact NT_STATUS lines in case notes", checked: false },
      { text: "Microsoft/NAS fixes: DFS referral, share/NTFS ACLs, SMB policy", checked: false },
      { text: "Re-test: EMP_HOME list one employee", checked: false },
      { text: "Re-test: mkdir and rmdir at EMP_HOME root", checked: false },
      { text: "If still blocked: turn on jCIFS DEBUG and run a single-user reproduce", checked: false },
      { text: "After fixes: turn ON policy for 1 test user; process and verify logs", checked: false },
      { text: "After hotfix from QA: update appliance", checked: false },
      { text: "Enable all user policies", checked: false },
      { text: "Update case with outputs and attach logs", checked: false }
    ];

    // UI elements
    const elChecklist = document.getElementById("checklist");
    const elStu = document.getElementById("inp-stu");
    const elEmp = document.getElementById("inp-emp");
    const elEnc = document.getElementById("chk-enc");
    const elNew = document.getElementById("inp-new");
    const btnAdd = document.getElementById("btn-add");
    const btnReset = document.getElementById("btn-reset");
    const btnExport = document.getElementById("btn-export");
    const btnMarkAll = document.getElementById("btn-mark-all");
    const btnUnmarkAll = document.getElementById("btn-unmark-all");

    // Commands
    function setCode(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }
    function updateCommands(stu, emp, enc) {
      const encFlag = enc ? " -e" : "";
      const preStu = `smbclient //cfisd.loc/DFS_Shares -U 'CFISD\\\\idauto' -m SMB3${encFlag} -c 'cd STU_HOME; allinfo ${stu}'`;
      const preEmp = `smbclient //cfisd.loc/DFS_Shares -U 'CFISD\\\\idauto' -m SMB3${encFlag} -c 'cd EMP_HOME; allinfo ${emp}'`;
      const writeEmp = `smbclient //cfisd.loc/DFS_Shares -U 'CFISD\\\\idauto' -m SMB3${encFlag} -c "cd EMP_HOME; mkdir __RI_DFS_TEST__; rmdir __RI_DFS_TEST__"`;
      setCode("cmd-pre-stu", preStu);
      setCode("cmd-pre-emp", preEmp);
      setCode("cmd-write-emp", writeEmp);
    }

    // Create checklist doc if missing
    async function ensureBaseDoc() {
      const snap = await listDoc.get();
      if (!snap.exists) {
        await listDoc.set({
          title: "CFISD – DFS/SMB troubleshooting",
          stu: "S249612",
          emp: "E085678",
          enc: false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // Seed default items
        const batch = db.batch();
        DEFAULT_ITEMS.forEach((it, i) => {
          const ref = itemsCol.doc();
          batch.set(ref, {
            text: it.text,
            checked: !!it.checked,
            order: i,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
      }
    }

    // Render items
    let itemsCache = []; // for export/mark-all
    function renderItems(docs) {
      itemsCache = docs;
      elChecklist.innerHTML = "";
      docs.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.className = "flex items-center gap-3 p-2 rounded-lg border border-slate-200";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "size-4";
        cb.checked = !!data.checked;
        cb.addEventListener("change", () => {
          doc.ref.update({
            checked: cb.checked,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        const label = document.createElement("label");
        label.textContent = data.text;
        label.className = "flex-1 text-sm";
        const del = document.createElement("button");
        del.textContent = "Remove";
        del.className = "text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200";
        del.addEventListener("click", () => doc.ref.delete());
        li.append(cb, label, del);
        elChecklist.appendChild(li);
      });
    }

    // Event handlers
    btnAdd.addEventListener("click", async () => {
      const text = (elNew.value || "").trim();
      if (!text) return toast("Enter an item");
      await itemsCol.add({
        text, checked: false, order: Date.now(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      elNew.value = "";
    });

    btnReset.addEventListener("click", async () => {
      if (!confirm("Restore default checklist items?")) return;
      const snapshot = await itemsCol.get();
      const batch = db.batch();
      snapshot.forEach(d => batch.delete(d.ref));
      DEFAULT_ITEMS.forEach((it, i) => {
        const ref = itemsCol.doc();
        batch.set(ref, {
          text: it.text,
          checked: !!it.checked,
          order: i,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      await batch.commit();
      toast("Defaults restored");
    });

    btnExport.addEventListener("click", async () => {
      const lines = itemsCache.map(d => `${d.data().checked ? "[x]" : "[ ]"} ${d.data().text}`);
      await navigator.clipboard.writeText(lines.join("\n"));
      toast("Exported to clipboard");
    });

    btnMarkAll.addEventListener("click", async () => {
      const batch = db.batch();
      itemsCache.forEach(d => batch.update(d.ref, { checked: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
      await batch.commit();
    });

    btnUnmarkAll.addEventListener("click", async () => {
      const batch = db.batch();
      itemsCache.forEach(d => batch.update(d.ref, { checked: false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
      await batch.commit();
    });

    elStu.addEventListener("input", () => listDoc.set({ stu: elStu.value || "S249612", updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));
    elEmp.addEventListener("input", () => listDoc.set({ emp: elEmp.value || "E085678", updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));
    elEnc.addEventListener("change", () => listDoc.set({ enc: !!elEnc.checked, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));

    async function init() {
      await ensureBaseDoc();

      listDoc.onSnapshot(snap => {
        const data = snap.data() || {};
        elStu.value = data.stu || "S249612";
        elEmp.value = data.emp || "E085678";
        elEnc.checked = !!data.enc;
        updateCommands(elStu.value, elEmp.value, elEnc.checked);
      });

      itemsCol.orderBy("order", "asc").onSnapshot(snap => renderItems(snap.docs));
    }

    // tiny toast
    function toast(msg) {
      const t = document.createElement("div");
      t.textContent = msg;
      t.className = "fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-2 rounded-lg shadow z-50";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1600);
    }

    // copy helper
    async function copyFrom(id) {
      const el = document.getElementById(id);
      const text = el ? el.innerText : "";
      try { await navigator.clipboard.writeText(text); toast("Copied"); }
      catch { toast("Copy failed"); }
    }

    // go
    init();
  </script>
</body>
</html>
