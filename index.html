<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CFISD DFS/SMB troubleshooting notes - Sep 26, 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* simple line-number look without extra libs */
    ol.loglines { counter-reset: item; }
    ol.loglines li::marker { color:#94a3b8; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold">CFISD - DFS / SMB troubleshooting notes</h1>
      <p class="text-sm text-slate-600 mt-1">Session date: Sep 26, 2025</p>
    </header>

    <section class="space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">recap</h2>
        <p class="mb-3">here’s a quick summary from tonight and where we landed.</p>
        <ul class="list-disc pl-6 space-y-1">
          <li>updated system.properties with ray's setting: <code>jcifs.smb.client.dfs.convertToFQDN=true</code>, then restarted folders.</li>
          <li>re-processed a single test user (E085678). user policies were later turned off while we continued to test.</li>
          <li>manual dfs connect from the appliance using <code>smbclient</code> failed on the domain dfs path:
            <code>smbclient //cfisd.loc/DFS_Shares/Emp_Home -U CFISD\idauto</code> &rarr; <span class="font-mono">NT_STATUS_BAD_NETWORK_NAME</span>.</li>
          <li>attempt to add <code>CFISD\idauto</code> to the <code>emp_home</code> share failed on their side. that points to a permission/policy or protocol constraint on that share.</li>
          <li>not presenting as dns now. this looks more like a configuration mismatch between the nas/smb service and the appliance (auth/policy/share access) specific to <code>emp_home</code>.</li>
          <li><code>stu_home</code> is accessible, but <code>emp_home</code> is not, using the same service account.</li>
        </ul>
      </div>

      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">current mitigation</h2>
        <p>policies tied to the affected paths remain disabled while we debug. testing was limited to E085678.</p>
      </div>

      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">next steps</h2>
        <ul class="list-disc pl-6 space-y-1">
          <li>meet monday evening, ideally with a microsoft rep, to debug dfs live.</li>
          <li>ray will review the data and bring a short list of targeted troubleshooting steps.</li>
          <li>use the working <code>stu_home</code> share as a control to compare behavior and isolate what is different on <code>emp_home</code>.</li>
        </ul>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">screenshots</h2>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-3">rapididentity ui + terminal overlay</figcaption>
        <img class="rounded-xl w-full" src="assets/error-terminal.png" alt="error terminal">
        <p class="text-sm text-slate-600 mt-2">note: earlier we saw ping to the nas returning different ips. captured here.</p>
      </figure>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-3">centos repo lookup error (not directly related)</figcaption>
        <img class="rounded-xl w-full" src="assets/centos-dnf-error.png" alt="centos dnf error">
      </figure>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-3">windows error when trying to add service account to emp_home</figcaption>
        <img class="rounded-xl w-full" src="assets/dfs-error.png" alt="dfs error">
      </figure>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">terminal transcripts (full run)</h2>

      <div class="bg-white shadow rounded-2xl p-5">
        <h3 class="text-lg font-semibold mb-2">appliance commands and results</h3>
        <pre class="bg-black text-green-200 p-4 rounded-xl overflow-x-auto"><code>
[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -U "CFISD\idauto"
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -m SMB2 -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
Encryption required and server doesn't support SMB3 encryption - failing connect
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -m SMB3 -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares -m SMB2 -U "CFISD\idauto"
Enter CFISD\idauto's password:
session setup failed: NT_STATUS_CONNECTION_RESET

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares -m SMB2 -U "CFISD\idauto"
Enter CFISD\idauto's password:
Try "help" to get a list of possible commands.
smb: \> ^C

[root@IDAUTOHOME2 idauto]# smbclient -L //cfisd.loc/DFS_Shares -m SMB2 -U "CFISD\idauto"
Enter CFISD\idauto's password:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share
        SYSVOL          Disk      Logon server share
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to cfisd.loc failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available

[root@IDAUTOHOME2 idauto]# smbclient //cftech.cfisd.loc/EMP_Home/ -m SMB3 -U "CFISD\idauto"
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_ACCESS_DENIED

[root@IDAUTOHOME2 idauto]# smbclient //cftech.cfisd.loc/STU_HOME/ -m SMB3 -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
Try "help" to get a list of possible commands.
smb: \> ^C
        </code></pre>
        <p class="text-sm text-slate-600 mt-3">read-out: dfs path to Emp_Home via cfisd.loc returns BAD_NETWORK_NAME. listing the dfs root works once (interactive shell) but also showed a connection reset earlier. direct host path to EMP_Home returns ACCESS_DENIED, while STU_HOME opens a shell.</p>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">rapididentity (jcifs) debug log excerpts</h2>

      <div class="bg-white shadow rounded-2xl p-5">
        <p class="mb-4 text-sm text-slate-700">relevant lines from rapididentity debug around the failures. these are the tree connect errors during SmbFile.exists(). times approximate to 17:31–18:00.</p>

        <h3 class="text-lg font-semibold mb-2">snippet 1</h3>
        <ol class="loglines bg-slate-900 text-slate-100 p-4 rounded-xl overflow-x-auto text-sm space-y-1">
          <li>[TRACE] Send failed</li>
          <li>jcifs.smb.SmbException: The network name cannot be found.</li>
          <li>  at jcifs.smb.SmbTransportImpl.checkStatus2(...)</li>
          <li>  at jcifs.smb.SmbTreeConnection.connect(...)</li>
          <li>  at jcifs.smb.SmbFile.ensureTreeConnected(...)</li>
          <li>  at jcifs.smb.SmbFile.exists(...)</li>
          <li>  at net.idauto.fms.UserPolicyProcessor.applyUserPolicy(...)</li>
          <li>[TRACE] Request: command=SMB2_TREE_CONNECT ...</li>
          <li>[TRACE] Response: null</li>
          <li>[DEBUG] Disconnect tree on treeConnectFailure</li>
        </ol>

        <h3 class="text-lg font-semibold mt-6 mb-2">snippet 2</h3>
        <ol class="loglines bg-slate-900 text-slate-100 p-4 rounded-xl overflow-x-auto text-sm space-y-1">
          <li>[TRACE] Send failed</li>
          <li>jcifs.smb.SmbException: The network name cannot be found.</li>
          <li>  at jcifs.smb.SmbTransportImpl.checkStatus2(...)</li>
          <li>  at jcifs.smb.SmbTreeConnection.connect(...)</li>
          <li>  at jcifs.smb.SmbFile.ensureTreeConnected(...)</li>
          <li>  at jcifs.smb.SmbFile.exists(...)</li>
          <li>[TRACE] Request: command=SMB2_TREE_CONNECT ...</li>
          <li>[TRACE] Response: null</li>
        </ol>

        <h3 class="text-lg font-semibold mt-6 mb-2">snippet 3</h3>
        <ol class="loglines bg-slate-900 text-slate-100 p-4 rounded-xl overflow-x-auto text-sm space-y-1">
          <li>[TRACE] Send failed</li>
          <li>jcifs.smb.SmbException: The network name cannot be found.</li>
          <li>  at jcifs.smb.SmbTransportImpl.checkStatus2(...)</li>
          <li>  at jcifs.smb.SmbTreeConnection.connect(...)</li>
          <li>  at jcifs.smb.SmbFile.ensureTreeConnected(...)</li>
          <li>  at jcifs.smb.SmbFile.exists(...)</li>
          <li>[DEBUG] treeConnect failed; disconnecting</li>
        </ol>

        <div class="mt-6 text-sm text-slate-700">
          <p>log level note: jcifs.smb logger is already at TRACE, so we are capturing low-level smb2 messages and tree connect attempts.</p>
        </div>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">notes / findings</h2>
      <div class="bg-white shadow rounded-2xl p-5">
        <pre class="bg-slate-100 text-slate-800 p-4 rounded-xl whitespace-pre-wrap">
what I am seeing in the logs collected:
- folders applied staff user policy and then checked \\cfisd.loc\DFS_Shares\emp_home\<user>
- code path failed in SmbFile.exists() with "the network name cannot be found"
- those errors look like a dfs namespace or referral problem
- from the same server, smbclient //cfisd.loc/DFS_Shares -U CFISD\idauto previously worked, so creds/connectivity are generally ok

extra:
- if smbclient to the dfs root works but emp_home fails while stu_home works, that points to share/ntfs/abe on emp_home
- manual smbclient failing is important because it is independent of the application
        </pre>
      </div>
    </section>

    <footer class="mt-12 pb-12 text-sm text-slate-500">
      <p>prepared for cfisd by identity automation support - sep 26, 2025</p>
    </footer>
  </div>
</body>
</html>
