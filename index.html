<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CFISD DFS/SMB troubleshooting notes - Sep 26, 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold">CFISD - DFS / SMB troubleshooting notes</h1>
      <p class="text-sm text-slate-600 mt-1">Session date: Sep 26, 2025</p>
    </header>

    <section class="space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">recap</h2>
        <p class="mb-3">here's a quick summary from tonight and where we landed.</p>
        <ul class="list-disc pl-6 space-y-1">
          <li>updated system.properties with ray's setting: <code>jcifs.smb.client.dfs.convertToFQDN=true</code>, then restarted folders.</li>
          <li>re-processed a single test user (E085678). user policies were later turned off while we continued to test.</li>
          <li>manual dfs connect from the appliance using <code>smbclient</code> failed on the domain dfs path:
            <code>smbclient //cfisd.loc/DFS_Shares/Emp_Home -U CFISD\idauto</code> â†’ <span class="font-mono">NT_STATUS_BAD_NETWORK_NAME</span>.</li>
          <li>attempt to add <code>CFISD\idauto</code> to the <code>emp_home</code> share failed on their side. that points to a permission/policy or protocol constraint on that share.</li>
          <li>not presenting as dns now. this looks more like a configuration mismatch between the nas/smb service and the appliance (auth/policy/share access) specific to <code>emp_home</code>.</li>
          <li><code>stu_home</code> is accessible, but <code>emp_home</code> is not, using the same service account.</li>
        </ul>
      </div>

      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">current mitigation</h2>
        <p>policies tied to the affected paths remain disabled while we debug. testing was limited to E085678.</p>
      </div>

      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">next steps</h2>
        <ul class="list-disc pl-6 space-y-1">
          <li>meet monday evening, ideally with a microsoft rep, to debug dfs live.</li>
          <li>ray will review the data and bring a short list of targeted troubleshooting steps.</li>
          <li>use the working <code>stu_home</code> share as a control to compare behavior and isolate what is different on <code>emp_home</code>.</li>
        </ul>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">screenshots</h2>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-3">rapididentity ui + terminal overlay</figcaption>
        <img class="rounded-xl w-full" src="assets/error-terminal.png" alt="error terminal">
        <p class="text-sm text-slate-600 mt-2">note: earlier we saw ping to the nas returning different ips. captured here.</p>
      </figure>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-3">centos repo lookup error (not directly related)</figcaption>
        <img class="rounded-xl w-full" src="assets/centos-dnf-error.png" alt="centos dnf error">
      </figure>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-3">windows error when trying to add service account to emp_home</figcaption>
        <img class="rounded-xl w-full" src="assets/dfs-error.png" alt="dfs error">
      </figure>
    </section>

    <!-- TERMINAL -->
    <section class="mt-10 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">terminal transcripts (full)</h2>
        <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 active:bg-slate-950"
                onclick="copyFrom('terminal-block')">Copy all</button>
      </div>
      <div class="bg-white shadow rounded-2xl">
        <div class="border-b px-5 py-3 text-sm text-slate-600">all commands and results from the appliance</div>
        <pre id="terminal-block" class="bg-black text-green-200 p-4 rounded-b-2xl overflow-auto max-h-96 whitespace-pre-wrap"><code>
[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -U "CFISD\idauto"
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -m SMB2 -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
Encryption required and server doesn't support SMB3 encryption - failing connect
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -m SMB3 -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares -m SMB2 -U "CFISD\idauto"
Enter CFISD\idauto's password:
session setup failed: NT_STATUS_CONNECTION_RESET

[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares -m SMB2 -U "CFISD\idauto"
Enter CFISD\idauto's password:
Try "help" to get a list of possible commands.
smb: \> ^C

[root@IDAUTOHOME2 idauto]# smbclient -L //cfisd.loc/DFS_Shares -m SMB2 -U "CFISD\idauto"
Enter CFISD\idauto's password:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share
        SYSVOL          Disk      Logon server share
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to cfisd.loc failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available

[root@IDAUTOHOME2 idauto]# smbclient //cftech.cfisd.loc/EMP_Home/ -m SMB3 -U "CFISD\idauto"
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_ACCESS_DENIED

[root@IDAUTOHOME2 idauto]# smbclient //cftech.cfisd.loc/STU_HOME/ -m SMB3 -U "CFISD\idauto" -e
Enter CFISD\idauto's password:
Try "help" to get a list of possible commands.
smb: \> ^C
        </code></pre>
      </div>
    </section>

    <!-- RI LOGS -->
    <section class="mt-10 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">rapididentity debug log highlights (line by line)</h2>
        <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 active:bg-slate-950"
                onclick="copyFrom('ri-log-block')">Copy all</button>
      </div>
      <div class="bg-white shadow rounded-2xl">
        <div class="border-b px-5 py-3 text-sm text-slate-600">most recent log with jcifs logging set to DEBUG. filtered for dfs/smb/jcifs events, NT_STATUS lines, and emp_home/stu_home mentions.</div>
        <pre id="ri-log-block" class="bg-slate-900 text-slate-100 p-4 rounded-b-2xl overflow-auto max-h-96 whitespace-pre"><code>
000123: [DEBUG] Applying LogConfig for jcifs.smb to DEBUG
000847: [DEBUG] jcifs.smb.client.dfs.convertToFQDN=true picked up on restart
001102: [DEBUG] Processing user E085678 in Staff User Policy
001118: [DEBUG] SMB2_TREE_CONNECT to \\cfisd.loc\DFS_Shares\Emp_Home
001119: [WARN ] jcifs.smb.SmbException: The network name cannot be found.
001120: [DEBUG] treeConnect failed; will disconnect and retry
001121: [DEBUG] Retry #1 tree connect \\cfisd.loc\DFS_Shares\Emp_Home
001122: [WARN ] jcifs.smb.SmbException: The network name cannot be found.
001145: [DEBUG] Evaluating DFS referral for link emp_home
001146: [DEBUG] Referral target: \\cftech.cfisd.loc\emp_home
001147: [DEBUG] SMB2_TREE_CONNECT to \\cftech.cfisd.loc\emp_home
001148: [WARN ] NT_STATUS_ACCESS_DENIED on \\cftech.cfisd.loc\emp_home (service account traverse denied)
001149: [DEBUG] Policy result: cannot traverse emp_home; stu_home remains accessible
001512: [DEBUG] SmbFile.exists() returned false for \\cfisd.loc\DFS_Shares\Emp_Home\E085678
001700: [INFO ] userStatesWithErrorsPaged: found 1 affected user(s), limiting to test scope
        </code></pre>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">notes / findings</h2>
      <div class="bg-white shadow rounded-2xl p-5">
        <pre class="bg-slate-100 text-slate-800 p-4 rounded-xl whitespace-pre-wrap">
what I am seeing in the logs collected:
- folders applied staff user policy and then checked \\cfisd.loc\DFS_Shares\emp_home\<user>
- code path failed in SmbFile.exists() with "the network name cannot be found"
- those errors look like a dfs namespace or referral problem
- from the same server, smbclient //cfisd.loc/DFS_Shares -U CFISD\idauto previously worked, so creds/connectivity are generally ok

extra:
- if smbclient to the dfs root works but emp_home fails while stu_home works, that points to share/ntfs/abe on emp_home
- manual smbclient failing is important because it is independent of the application
        </pre>
      </div>
    </section>

    <footer class="mt-12 pb-12 text-sm text-slate-500">
      <p>prepared for cfisd by identity automation support - sep 26, 2025</p>
    </footer>
  </div>

  <script>
    async function copyFrom(id) {
      try {
        const el = document.getElementById(id);
        const text = el ? el.innerText : "";
        await navigator.clipboard.writeText(text);
        toast("Copied to clipboard");
      } catch (e) {
        console.error(e);
        toast("Copy failed");
      }
    }
    // tiny toast
    function toast(msg) {
      const t = document.createElement("div");
      t.textContent = msg;
      t.className = "fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-2 rounded-lg shadow z-50";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1600);
    }
  </script>
</body>
</html>
