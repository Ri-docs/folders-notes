<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CFISD DFS/SMB troubleshooting notes – Oct 3, 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .dragging { opacity: .6; }
    .drag-over { outline: 2px dashed rgb(148 163 184); }
    .drag-handle { cursor: grab; user-select: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold">CFISD – DFS / SMB troubleshooting notes</h1>
    </header>

    <section class="space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h2 class="text-xl font-semibold">Tonight plan checklist</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btn-mark-all" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800">Mark all done</button>
            <button id="btn-unmark-all" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-900 text-sm hover:bg-slate-200">Unmark all</button>
            <button id="btn-reset" class="px-3 py-1.5 rounded-lg bg-rose-50 text-rose-700 text-sm hover:bg-rose-100">Restore defaults</button>
            <button id="btn-clear" class="px-3 py-1.5 rounded-lg bg-amber-50 text-amber-700 text-sm hover:bg-amber-100">Clear all</button>
            <button id="btn-bulk" class="px-3 py-1.5 rounded-lg bg-sky-50 text-sky-700 text-sm hover:bg-sky-100">Bulk add</button>
            <button id="btn-export" class="px-3 py-1.5 rounded-lg bg-slate-50 text-slate-700 text-sm hover:bg-slate-100">Export</button>
          </div>
        </div>

        <div class="grid sm:grid-cols-4 gap-3 mt-3">
          <label class="text-sm">Student test ID
            <input id="inp-stu" type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-1.5" placeholder="S249612" />
          </label>
          <label class="text-sm">Employee test ID
            <input id="inp-emp" type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-1.5" placeholder="E085678" />
          </label>
          <label class="flex items-center gap-2 text-sm mt-6 sm:mt-0">
            <input id="chk-enc" type="checkbox" class="size-4" />
            <span>Add <code>-e</code> encryption flag to smbclient</span>
          </label>
          <label class="text-sm">List id (query param)
            <input id="inp-list" type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-1.5" disabled />
          </label>
        </div>

        <ul id="checklist" class="mt-4 space-y-2"></ul>

        <div class="mt-4 flex gap-2">
          <input id="inp-new" type="text" class="flex-1 rounded-lg border border-slate-300 px-3 py-1.5" placeholder="Add custom checklist item" />
          <button id="btn-add" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700">Add</button>
        </div>

        <!-- Bulk add panel -->
        <div id="bulk-panel" class="hidden mt-4 border rounded-xl p-3 bg-slate-50">
          <div class="text-sm mb-2">Paste one item per line:</div>
          <textarea id="bulk-text" class="w-full h-40 border border-slate-300 rounded-lg p-3 font-mono text-sm" placeholder="[ ] First item&#10;[ ] Second item"></textarea>
          <div class="mt-2 flex gap-2">
            <button id="bulk-add-go" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">Add items</button>
            <button id="bulk-cancel" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-900 text-sm">Close</button>
          </div>
        </div>
      </div>

      <div class="bg-white shadow rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Quick commands</h2>
          <div class="text-xs text-slate-500">Run on the appliance. Enter password at the prompt.</div>
        </div>
        <div class="mt-3 grid md:grid-cols-2 gap-4">
          <div class="border rounded-xl p-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">DFS control (student) – list one</h3>
              <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-pre-stu')">Copy</button>
            </div>
            <pre id="cmd-pre-stu" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          </div>
          <div class="border rounded-xl p-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">DFS under test (employee) – list one</h3>
              <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-pre-emp')">Copy</button>
            </div>
            <pre id="cmd-pre-emp" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          </div>
          <div class="border rounded-xl p-3 md:col-span-2">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">Write check on EMP_HOME root</h3>
              <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-write-emp')">Copy</button>
            </div>
            <pre id="cmd-write-emp" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          </div>
        </div>

        <div class="mt-4 border rounded-xl p-3">
          <div class="flex items-center justify-between">
            <h3 class="font-medium">Version & environment checks</h3>
            <button class="px-2 py-1 rounded bg-slate-900 text-white text-xs" onclick="copyFrom('cmd-version')">Copy</button>
          </div>
          <pre id="cmd-version" class="mt-2 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap"><code></code></pre>
          <p class="text-xs text-slate-500 mt-2">
            Note: Samba 4.15+ is required for reliable DFS behavior. Appliance is on CentOS 7 / Samba 4.10 per Microsoft’s check—likely the root cause. Plan: move appliance to CentOS 8 (or supported equivalent) with Samba ≥4.15, then retest.
          </p>
        </div>
      </div>
    </section>

    <section class="mt-10 space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">recap</h2>
        <ul class="list-disc pl-6 space-y-1">
          <li>Set <code>jcifs.smb.client.dfs.convertToFQDN=true</code> and restarted Folders.</li>
          <li>Tested a single user; then turned off User Policies for safety.</li>
          <li><code>smbclient</code> to DFS root worked; <code>STU_HOME</code> traversed; <code>EMP_HOME</code> failed.</li>
          <li>Confirmed <code>CFISD\idauto</code> is on the share (see screenshots).</li>
          <li>Observed unexpected principals being granted share permissions (investigate source).</li>
          <li>Microsoft confirmed DFS works from Windows and the appliance Samba 4.10 (CentOS 7) is likely the blocker; need Samba 4.15+ (CentOS 8 image).</li>
        </ul>
      </div>
    </section>

    <section class="mt-10 space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">current mitigation</h2>
        <p>User policies tied to the affected paths remain disabled. Testing limited to one employee test user.</p>
      </div>

      <div class="bg-white shadow rounded-2xl p-5">
        <h2 class="text-xl font-semibold mb-2">next steps</h2>
        <ul class="list-disc pl-6 space-y-1">
          <li>Work with Microsoft/NAS to align share/NTFS/ABE/encryption with STU_HOME while we plan the OS upgrade.</li>
          <li>If you need a temporary path: point the policy to the backend share (non‑DFS) for EMP only, then revert after upgrade.</li>
          <li>After the appliance upgrade and/or dev hotfix, retest DFS with a single test user first, watch for Wake signature.</li>
        </ul>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">screenshots (latest)</h2>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-2">Service account present on share</figcaption>
        <img class="rounded-xl w-full" src="https://github.com/user-attachments/assets/23cc91ab-c16f-482e-bb8c-0d34baaaf7d0" alt="service account on share">
      </figure>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-2">Unexpected share permission grants (investigate source)</figcaption>
        <img class="rounded-xl w-full" src="https://github.com/user-attachments/assets/8d8162ac-1a65-4dd6-ad7d-b2db1d773210" alt="unexpected share permission grants">
      </figure>

      <figure class="bg-white shadow rounded-2xl p-5">
        <figcaption class="font-medium mb-2">DFS is healthy from Windows</figcaption>
        <img class="rounded-xl w-full" src="https://github.com/user-attachments/assets/944f08d5-a05c-4566-9188-657c91e9478d" alt="DFS verified from Windows">
      </figure>
    </section>

    <section class="mt-10 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">terminal transcripts (full)</h2>
        <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 active:bg-slate-950"
                onclick="copyFrom('terminal-block')">Copy all</button>
      </div>
      <div class="bg-white shadow rounded-2xl">
        <div class="border-b px-5 py-3 text-sm text-slate-600">all commands and results from the appliance</div>
        <pre id="terminal-block" class="bg-black text-green-200 p-4 rounded-b-2xl overflow-auto max-h-96 whitespace-pre-wrap"><code>
[root@IDAUTOHOME2 idauto]# smbclient //cfisd.loc/DFS_Shares/Emp_Home -U "CFISD\idauto"
Enter CFISD\idauto's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME
... (trimmed for brevity; keep your original full transcript here)
        </code></pre>
      </div>
    </section>

    <section class="mt-10 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">rapididentity debug log highlights (line by line)</h2>
        <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 active:bg-slate-950"
                onclick="copyFrom('ri-log-block')">Copy all</button>
      </div>
      <div class="bg-white shadow rounded-2xl">
        <div class="border-b px-5 py-3 text-sm text-slate-600">jcifs debug on. filtered for dfs, smb, jcifs, NT_STATUS, emp_home or stu_home.</div>
        <pre id="ri-log-block" class="bg-slate-900 text-slate-100 p-4 rounded-b-2xl overflow-auto max-h-96 whitespace-pre"><code>
000123: [DEBUG] Applying LogConfig for jcifs.smb to DEBUG
... (keep your snippet)
        </code></pre>
      </div>
    </section>

    <!-- Wake signature checker -->
    <section class="mt-10 space-y-4">
      <div class="bg-white shadow rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">wake-style jcifs path parsing - quick check</h2>
          <div class="text-xs text-slate-500">paste RI log lines below, then click highlight</div>
        </div>
        <textarea id="log-input" class="mt-3 w-full h-40 border border-slate-300 rounded-lg p-3 font-mono text-sm" placeholder="paste log lines here"></textarea>
        <div class="mt-2 flex gap-2">
          <button id="btn-analyze" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">Highlight</button>
          <button id="btn-copy-flagged" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-900 text-sm">Copy flagged</button>
          <span id="sig-result" class="text-sm text-slate-600 ml-2"></span>
        </div>
        <pre id="log-flagged" class="mt-3 bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto whitespace-pre-wrap max-h-80"></pre>
      </div>
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="text-2xl font-semibold">notes / findings</h2>
      <div class="bg-white shadow rounded-2xl p-5">
        <pre class="bg-slate-100 text-slate-800 p-4 rounded-xl whitespace-pre-wrap">
what I am seeing in the logs collected:
- folders applied staff user policy and then checked \\cfisd.loc\\DFS_Shares\\emp_home\<user>
- code path failed in SmbFile.exists() with "the network name cannot be found"
- those errors look like a dfs namespace or referral problem
- from the same server, smbclient //cfisd.loc/DFS_Shares -U CFISD\\idauto previously worked, so creds/connectivity are generally ok

extra (new):
- service account confirmed on share; unexpected identities being granted share perms (investigate source)
- DFS healthy on Windows; appliance Samba 4.10 on CentOS 7 doesn't fully support DFS behavior needed; target Samba 4.15+ on CentOS 8 for long-term fix
        </pre>
      </div>
    </section>

    <footer class="mt-12 pb-12 text-sm text-slate-500">
    </footer>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AlzaSyBK_f7xHtJS_Yqj6SWF6UGcPLGxX1SVrDw",
      authDomain: "test-d4e6b.firebaseapp.com",
      projectId: "test-d4e6b",
      storageBucket: "test-d4e6b.appspot.com",
      messagingSenderId: "172115547160",
      appId: "1:172115547160:web:9d8190327c4277df0b5f6d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.enablePersistence({ synchronizeTabs: true }).catch(() => {});
    const listId = new URLSearchParams(location.search).get("list") || "cyfair";
    document.getElementById("inp-list").value = listId;
    const listDoc = db.collection("checklists").doc(listId);
    const itemsCol = listDoc.collection("items");

    const DEFAULT_ITEMS = [

    ];

    const elChecklist = document.getElementById("checklist");
    const elStu = document.getElementById("inp-stu");
    const elEmp = document.getElementById("inp-emp");
    const elEnc = document.getElementById("chk-enc");
    const elNew = document.getElementById("inp-new");
    const btnAdd = document.getElementById("btn-add");
    const btnReset = document.getElementById("btn-reset");
    const btnExport = document.getElementById("btn-export");
    const btnMarkAll = document.getElementById("btn-mark-all");
    const btnUnmarkAll = document.getElementById("btn-unmark-all");
    const btnClear = document.getElementById("btn-clear");
    const btnBulk = document.getElementById("btn-bulk");
    const bulkPanel = document.getElementById("bulk-panel");
    const bulkText = document.getElementById("bulk-text");
    const bulkGo = document.getElementById("bulk-add-go");
    const bulkCancel = document.getElementById("bulk-cancel");

    function setCode(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
    function updateCommands(stu, emp, enc) {
      const encFlag = enc ? " -e" : "";
      const preStu = `smbclient //cfisd.loc/DFS_Shares -U 'CFISD\\\\idauto' -m SMB3${encFlag} -c 'cd STU_HOME; allinfo ${stu}'`;
      const preEmp = `smbclient //cfisd.loc/DFS_Shares -U 'CFISD\\\\idauto' -m SMB3${encFlag} -c 'cd EMP_HOME; allinfo ${emp}'`;
      const writeEmp = `smbclient //cfisd.loc/DFS_Shares -U 'CFISD\\\\idauto' -m SMB3${encFlag} -c "cd EMP_HOME; mkdir __RI_DFS_TEST__; rmdir __RI_DFS_TEST__"`;
      const version = `smbclient --version && echo -n "OS: " && cat /etc/*release 2>/dev/null | head -n1 && rpm -qa | grep -i "^samba" | sort`;
      setCode("cmd-pre-stu", preStu);
      setCode("cmd-pre-emp", preEmp);
      setCode("cmd-write-emp", writeEmp);
      setCode("cmd-version", version);
    }

    async function ensureBaseDoc() {
      const snap = await listDoc.get();
      if (!snap.exists) {
        await listDoc.set({
          title: "CFISD – DFS/SMB troubleshooting",
          stu: "S249612",
          emp: "E085678",
          enc: false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        const batch = db.batch();
        DEFAULT_ITEMS.forEach((it, i) => {
          const ref = itemsCol.doc();
          batch.set(ref, {
            text: it.text,
            checked: !!it.checked,
            order: i,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
      }
    }

    let itemsCache = [];
    function renderItems(docs) {
      itemsCache = docs;
      elChecklist.innerHTML = "";
      docs.forEach((doc, idx) => {
        const data = doc.data();
        const li = document.createElement("li");
        li.className = "flex items-center gap-3 p-2 rounded-lg border border-slate-200";
        li.draggable = true;
        li.dataset.index = idx;

        // drag handle + checkbox + label + remove
        const handle = document.createElement("span");
        handle.textContent = "⋮⋮";
        handle.title = "Drag to reorder";
        handle.className = "drag-handle text-slate-400 px-2";

        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.className = "size-4"; cb.checked = !!data.checked;
        cb.addEventListener("change", () => doc.ref.update({
          checked: cb.checked,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }));

        const label = document.createElement("label");
        label.textContent = data.text; label.className = "flex-1 text-sm";

        const del = document.createElement("button");
        del.textContent = "Remove";
        del.className = "text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200";
        del.addEventListener("click", () => doc.ref.delete());

        li.append(handle, cb, label, del);
        elChecklist.appendChild(li);

        li.addEventListener("dragstart", e => {
          li.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", String(idx));
        });
        li.addEventListener("dragend", () => li.classList.remove("dragging"));
        li.addEventListener("dragover", e => {
          e.preventDefault();
          li.classList.add("drag-over");
          e.dataTransfer.dropEffect = "move";
        });
        li.addEventListener("dragleave", () => li.classList.remove("drag-over"));
        li.addEventListener("drop", async e => {
          e.preventDefault();
          li.classList.remove("drag-over");
          const from = Number(e.dataTransfer.getData("text/plain"));
          const to = idx;
          if (Number.isNaN(from) || from === to) return;

          const arr = itemsCache.slice();
          const [moved] = arr.splice(from, 1);
          arr.splice(to, 0, moved);

          const batch = db.batch();
          arr.forEach((d, i) => batch.update(d.ref, { order: i, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
          await batch.commit();
        });
      });
    }

    document.getElementById("btn-add").addEventListener("click", async () => {
      const text = (elNew.value || "").trim();
      if (!text) return toast("Enter an item");
      await itemsCol.add({
        text, checked: false, order: Date.now(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      elNew.value = "";
    });

    btnReset.addEventListener("click", async () => {
      if (!confirm("Restore default checklist items?")) return;
      const snapshot = await itemsCol.get();
      const batch = db.batch();
      snapshot.forEach(d => batch.delete(d.ref));
      DEFAULT_ITEMS.forEach((it, i) => {
        const ref = itemsCol.doc();
        batch.set(ref, {
          text: it.text, checked: !!it.checked, order: i,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      await batch.commit();
      toast("Defaults restored");
    });

    btnClear.addEventListener("click", async () => {
      if (!confirm("Clear ALL checklist items?")) return;
      const snapshot = await itemsCol.get();
      const batch = db.batch();
      snapshot.forEach(d => batch.delete(d.ref));
      await batch.commit();
      toast("Checklist cleared");
    });

    btnBulk.addEventListener("click", () => { bulkPanel.classList.toggle("hidden"); });
    bulkCancel.addEventListener("click", () => { bulkPanel.classList.add("hidden"); });

    bulkGo.addEventListener("click", async () => {
      const lines = (bulkText.value || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (!lines.length) return toast("Nothing to add");
      const batch = db.batch();
      lines.forEach((t, i) => {
        const ref = itemsCol.doc();
        const text = t.replace(/^\[(x| )\]\s*/i, ""); 
        batch.set(ref, {
          text, checked: /^\[x\]/i.test(t), order: Date.now() + i,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      await batch.commit();
      bulkText.value = "";
      toast("Items added");
    });

    btnExport.addEventListener("click", async () => {
      const lines = itemsCache.map(d => `${d.data().checked ? "[x]" : "[ ]"} ${d.data().text}`);
      await navigator.clipboard.writeText(lines.join("\n"));
      toast("Exported to clipboard");
    });

    btnMarkAll.addEventListener("click", async () => {
      const batch = db.batch();
      itemsCache.forEach(d => batch.update(d.ref, { checked: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
      await batch.commit();
    });
    btnUnmarkAll.addEventListener("click", async () => {
      const batch = db.batch();
      itemsCache.forEach(d => batch.update(d.ref, { checked: false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
      await batch.commit();
    });

    elStu.addEventListener("input", () => listDoc.set({ stu: elStu.value || "S249612", updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));
    elEmp.addEventListener("input", () => listDoc.set({ emp: elEmp.value || "E085678", updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));
    elEnc.addEventListener("change", () => listDoc.set({ enc: !!elEnc.checked, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));

    async function init() {
      await ensureBaseDoc();
      listDoc.onSnapshot(snap => {
        const data = snap.data() || {};
        elStu.value = data.stu || "S249612";
        elEmp.value = data.emp || "E085678";
        elEnc.checked = !!data.enc;
        updateCommands(elStu.value, elEmp.value, elEnc.checked);
      });
      itemsCol.orderBy("order", "asc").onSnapshot(snap => renderItems(snap.docs));
    }

    function toast(msg) {
      const t = document.createElement("div");
      t.textContent = msg;
      t.className = "fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-2 rounded-lg shadow z-50";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1600);
    }

    async function copyFrom(id) {
      const el = document.getElementById(id);
      const text = el ? el.innerText : "";
      try { await navigator.clipboard.writeText(text); toast("Copied"); }
      catch { toast("Copy failed"); }
    }

    const inp = document.getElementById('log-input');
    const out = document.getElementById('log-flagged');
    const sig = document.getElementById('sig-result');
    document.getElementById('btn-analyze').addEventListener('click', () => {
      const lines = (inp.value || '').split(/\r?\n/);
      const want = /(SmbResourceLocatorImpl|UNC is|Consumed|Remaining|NT_STATUS|SmbException)/i;
      const flagged = [];
      const buckets = {};
      for (const ln of lines) {
        if (want.test(ln)) {
          flagged.push(ln);
          const ts = (ln.match(/^\d{1,2}:\d{2}:\d{2}\.\d{3}/) || [''])[0];
          if (!buckets[ts]) buckets[ts] = {unc:0,cons:0,rem:0};
          if (/UNC is/i.test(ln)) buckets[ts].unc++;
          if (/Consumed/i.test(ln)) buckets[ts].cons++;
          if (/Remaining/i.test(ln)) buckets[ts].rem++;
        }
      }
      out.textContent = flagged.join('\n');
      const hit = Object.values(buckets).some(b => b.unc && b.cons && b.rem);
      sig.textContent = hit ? 'Possible Wake-style path munging found' : 'No obvious path-munging signature';
      sig.className = hit ? 'text-sm text-rose-700' : 'text-sm text-emerald-700';
    });
    document.getElementById('btn-copy-flagged').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(out.textContent || ''); toast('Copied'); }
      catch { toast('Copy failed'); }
    });

    init();
  </script>
</body>
</html>
